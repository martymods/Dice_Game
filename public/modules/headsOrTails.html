<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Heads or Tails</title>
    <link rel="stylesheet" href="/style.css">
    <link rel="stylesheet" href="/headsOrTails.css"> <!-- Include the scoped stylesheet -->
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <script src="/app.js" type="module"></script>
    <script src="/modules/ui.js" type="module"></script>
</head>
<body id="heads-or-tails">
    <div id="game-container">
        <h1>Heads or Tails</h1>
        <p id="game-rules">Select Heads or Tails, place your ETH bet, and flip the coin to win!</p>

        <div id="selection">
            <button id="heads-button">Heads</button>
            <button id="tails-button">Tails</button>
        </div>

        <div id="betting-section">
            <label for="bet-amount">Place Your Bet (ETH):</label>
            <input type="number" id="bet-amount" placeholder="e.g., 0.01" min="0.01">
            <button id="place-bet-button">Place Bet</button>
        </div>

        <div id="flip-section" style="display: none;">
            <div id="coin-display">
                <img src="/images/CoinToss_Quarter.gif" id="coin-animation" alt="Coin Toss">
            </div>
            <button id="flip-coin-button">Flip Coin</button>
        </div>

        <div id="result-section" style="display: none;">
            <h2 id="flip-result">Result: </h2>
            <p id="winner-message"></p>
        </div>

        <div id="history-section">
            <h3>Last 3 Results</h3>
            <ul id="result-history"></ul>
        </div>

        <div id="leaderboard-section">
            <h3>Winners Leaderboard</h3>
            <ul id="leaderboard"></ul>
        </div>
    </div>

    <script type="module">
        import { ethers } from 'https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.esm.min.js';

        const provider = new ethers.providers.Web3Provider(window.ethereum);
        const signer = provider.getSigner();

        const resultHistory = [];
        const leaderboard = [];
        let userSelection = '';
        let ambienceTimeout, musicTimeout;

        const coinImage = document.getElementById('coin-animation');
        const headsButton = document.getElementById('heads-button');
        const tailsButton = document.getElementById('tails-button');
        const flipCoinButton = document.getElementById('flip-coin-button');

        headsButton.addEventListener('click', () => setSelection('heads'));
        tailsButton.addEventListener('click', () => setSelection('tails'));

        function setSelection(selection) {
            userSelection = selection;

            // Disable selection buttons until the flip is resolved
            headsButton.disabled = true;
            tailsButton.disabled = true;

            // Update the coin display based on the selection
            if (selection === 'heads') {
                coinImage.src = '/images/Coin_Quarter_Float_Heads.gif';
            } else if (selection === 'tails') {
                coinImage.src = '/images/Coin_Quarter_Float_Tails.gif';
            }

            document.getElementById('flip-section').style.display = 'block';
        }

        flipCoinButton.addEventListener('click', () => {
            if (!userSelection) {
                alert('Please select Heads or Tails.');
                return;
            }

            // Disable the Flip Coin button to prevent multiple presses
            flipCoinButton.disabled = true;

            const resultText = document.getElementById('flip-result');

            // Reset result text and play flipping animation
            resultText.textContent = '';
            coinImage.src = '/images/CoinToss_Quarter.gif';

            // Play sound for coin flip
            const flipSound = new Audio('/sounds/CoinToss.mp3');
            flipSound.play();

            setTimeout(() => {
                // Determine the result
                const flipResult = Math.random() < 0.5 ? 'heads' : 'tails';
                const isWinner = userSelection === flipResult;

                // Show the result animation
                if (flipResult === 'heads') {
                    coinImage.src = '/images/CoinToss_Quarter_Heads.gif';
                    setTimeout(() => {
                        coinImage.src = '/images/CoinToss_Quarter_Heads_loop.gif';
                    }, 2000);
                } else {
                    coinImage.src = '/images/CoinToss_Quarter_Tails.gif';
                    setTimeout(() => {
                        coinImage.src = '/images/CoinToss_Quarter_Tails_loop.gif';
                    }, 2000);
                }

                // Play win or lose sound
                const resultSound = new Audio(isWinner ? '/sounds/CoinToss_Win.mp3' : '/sounds/CoinToss_Lose.mp3');
                resultSound.play();

                // Display result text
                resultText.textContent = `Result: ${flipResult.toUpperCase()}`;
                document.getElementById('winner-message').textContent = isWinner ? 'You won!' : 'You lost!';
                document.getElementById('result-section').style.display = 'block';

                // Re-enable buttons after the result is shown
                headsButton.disabled = false;
                tailsButton.disabled = false;
                flipCoinButton.disabled = false;

                // Update history and leaderboard
                resultHistory.unshift({ flipResult, isWinner });
                if (resultHistory.length > 3) resultHistory.pop();
                updateHistoryUI();

                if (isWinner) {
                    leaderboard.push({ user: 'You', winnings: '2x your bet' });
                    updateLeaderboardUI();
                }
            }, 5800); // Wait for CoinToss_Quarter.gif to finish
        });

        function playAmbience() {
            const delay = Math.random() * 180000; // Random delay between 0 and 180 seconds
            ambienceTimeout = setTimeout(() => {
                const ambience = new Audio('/sounds/Ambience1.mp3');
                ambience.play();
                playAmbience();
            }, delay);
        }

        function playMusic() {
            const delay = Math.random() * 180000; // Random delay between 0 and 180 seconds
            musicTimeout = setTimeout(() => {
                const music = new Audio('/sounds/Music1.mp3');
                music.play();
                playMusic();
            }, delay + 280000); // Add 4:40 (280 seconds) to ensure no overlap
        }

        function updateHistoryUI() {
            const historyList = document.getElementById('result-history');
            historyList.innerHTML = '';
            resultHistory.forEach((result, index) => {
                const li = document.createElement('li');
                li.textContent = `Flip ${index + 1}: ${result.flipResult.toUpperCase()} (${result.isWinner ? 'Won' : 'Lost'})`;
                historyList.appendChild(li);
            });
        }

        function updateLeaderboardUI() {
            const leaderboardList = document.getElementById('leaderboard');
            leaderboardList.innerHTML = '';
            leaderboard.forEach((entry) => {
                const li = document.createElement('li');
                li.textContent = `${entry.user}: ${entry.winnings}`;
                leaderboardList.appendChild(li);
            });
        }

        // Start ambient and music playback loops
        playAmbience();
        playMusic();
    </script>
</body>
</html>

